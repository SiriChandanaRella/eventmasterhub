{% extends "base.html" %}

{% block title %}Calendar - EventMasterHub{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-calendar me-2"></i>
                    Event Calendar
                </h2>
                <div class="btn-group">
                    <a href="{{ url_for('event_list') }}" class="btn btn-outline-primary">
                        <i class="fas fa-list me-2"></i>List View
                    </a>
                    <button class="btn btn-outline-secondary" onclick="calendar.today()">
                        <i class="fas fa-calendar-day me-2"></i>Today
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Legend -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h6>Legend:</h6>
                    <div class="d-flex flex-wrap gap-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary rounded me-2" style="width: 16px; height: 16px;"></div>
                            <small>Upcoming Events</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="bg-success rounded me-2" style="width: 16px; height: 16px;"></div>
                            <small>Available Registration</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="bg-warning rounded me-2" style="width: 16px; height: 16px;"></div>
                            <small>Nearly Full</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="bg-danger rounded me-2" style="width: 16px; height: 16px;"></div>
                            <small>Fully Booked</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Event Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalTitle">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventModalBody">
                <!-- Event details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" class="btn btn-primary" id="eventModalDetailsBtn">View Full Details</a>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
    
    window.calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: function(fetchInfo, successCallback, failureCallback) {
            // Fetch events from API
            fetch('/api/events')
                .then(response => response.json())
                .then(data => {
                    var events = data.map(event => ({
                        id: event.id,
                        title: event.title,
                        start: event.start,
                        url: event.url,
                        description: event.description,
                        location: event.location,
                        category: event.category,
                        color: getEventColor(event)
                    }));
                    successCallback(events);
                })
                .catch(error => {
                    console.error('Error fetching events:', error);
                    failureCallback(error);
                });
        },
        eventClick: function(info) {
            info.jsEvent.preventDefault();
            
            // Populate modal with event details
            document.getElementById('eventModalTitle').textContent = info.event.title;
            document.getElementById('eventModalBody').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-calendar me-2"></i>Date & Time</h6>
                        <p>${new Date(info.event.start).toLocaleDateString('en-US', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-map-marker-alt me-2"></i>Location</h6>
                        <p>${info.event.extendedProps.location}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-tag me-2"></i>Category</h6>
                        <span class="badge bg-secondary">${info.event.extendedProps.category}</span>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6><i class="fas fa-info-circle me-2"></i>Description</h6>
                        <p>${info.event.extendedProps.description}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('eventModalDetailsBtn').href = info.event.url;
            eventModal.show();
        },
        eventDidMount: function(info) {
            // Add tooltip
            info.el.setAttribute('title', info.event.title + ' - ' + info.event.extendedProps.location);
        }
    });
    
    calendar.render();
    
    function getEventColor(event) {
        // Color code events based on some criteria
        // This is a simple example - you might want to base it on registration status
        var colors = {
            'Technology': '#0d6efd',
            'Business': '#198754',
            'Education': '#ffc107',
            'Entertainment': '#dc3545',
            'Sports': '#fd7e14',
            'Health': '#20c997',
            'General': '#6c757d'
        };
        return colors[event.category] || '#6c757d';
    }
});
</script>
{% endblock %}
